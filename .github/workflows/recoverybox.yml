###########################################################
#   Description: Compile recoverybox by GitHub Actions      #
#   Based on:  openwrt19.07.10                              #
#   Author: Teasiu                                        #
###########################################################

name: autobox

on:
  repository_dispatch:
  workflow_dispatch:
  push:
    branches: 
      - main
  # å¦‚éœ€å®šæ—¶æž„å»ºå¯å–æ¶ˆæ³¨é‡Š
  # schedule:
  #   - cron: 0 8 * * 5  # æ¯å‘¨äº”æ—©8ç‚¹ï¼ˆUTCï¼‰æ‰§è¡Œ
  # watch:
  #   types: [started]

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 180  # å¢žåŠ è¶…æ—¶æŽ§åˆ¶ï¼Œé˜²æ­¢æ— é™æŒ‚èµ·

    steps:
    - name: Checkout code
      uses: actions/checkout@v4  # ä½¿ç”¨å›ºå®šç‰ˆæœ¬ï¼Œæé«˜ç¨³å®šæ€§
      with:
        fetch-depth: 1  # ä»…æ‹‰å–æœ€æ–°æäº¤ï¼Œå‡å°‘è€—æ—¶

    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # æ¸…ç†æ—§ç¼“å­˜ï¼Œæ›´æ–°æº
        sudo -E apt-get clean
        sudo -E apt-get update -y
        # å®‰è£…ä¾èµ–ï¼ˆä¿æŒåŽŸä¾èµ–åˆ—è¡¨ï¼Œå¢žåŠ é”™è¯¯é€€å‡ºï¼‰
        sudo -E apt-get -y install \
          build-essential asciidoc binutils bzip2 gawk gettext git \
          libncurses5-dev libz-dev patch python3 python2.7 unzip zlib1g-dev \
          lib32gcc1 libc6-dev-i386 subversion flex uglifyjs git-core \
          gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo \
          libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake \
          libtool autopoint device-tree-compiler g++-multilib antlr3 gperf \
          wget curl swig rsync qemu-utils android-sdk-ext4-utils
        # è®¾ç½®æ—¶åŒº
        sudo timedatectl set-timezone "Asia/Shanghai"
        # æ£€æŸ¥ä¾èµ–å®‰è£…ç»“æžœ
        if [ $? -ne 0 ]; then
          echo "ä¾èµ–å®‰è£…å¤±è´¥"
          exit 1
        fi

    - name: Build 64bit & 32bit recoverybox
      run: |
        # åˆå§‹åŒ– feeds
        ./scripts/feeds update -a || { echo "feedsæ›´æ–°å¤±è´¥"; exit 1; }
        ./scripts/feeds install -a > /dev/null 2>&1 || { echo "feedså®‰è£…å¤±è´¥"; exit 1; }
        
        # æž„å»º64ä½ç‰ˆæœ¬
        cp recoverybox64.config .config
        make defconfig || { echo "64ä½defconfigå¤±è´¥"; exit 1; }
        # é™åˆ¶å¹¶è¡Œç¼–è¯‘æ•°ï¼ˆé˜²æ­¢èµ„æºè€—å°½ï¼Œä½¿ç”¨CPUæ ¸å¿ƒæ•°çš„ä¸€åŠï¼‰
        make -j$(($(nproc)/2)) || { echo "64ä½ç¼–è¯‘å¤±è´¥"; exit 1; }
        # ç”Ÿæˆext4é•œåƒ
        make_ext4fs -l 64M -s bin/recoverybox64.ext4 build_dir/target-aarch64_generic_musl/root-armvirt
        cp bin/targets/armvirt/64/openwrt-armvirt-64-root.ext4.gz bin/ || { echo "64ä½æ–‡ä»¶å¤åˆ¶å¤±è´¥"; exit 1; }
        
        # æ¸…ç†çŽ¯å¢ƒ
        make clean || { echo "æ¸…ç†å¤±è´¥"; exit 1; }
        
        # æž„å»º32ä½ç‰ˆæœ¬
        cp recoverybox32.config .config
        make defconfig || { echo "32ä½defconfigå¤±è´¥"; exit 1; }
        make -j$(($(nproc)/2)) || { echo "32ä½ç¼–è¯‘å¤±è´¥"; exit 1; }
        make_ext4fs -l 64M -s bin/recoverybox32.ext4 build_dir/target-arm_cortex-a15+neon-vfpv4_musl_eabi/root-armvirt
        cp bin/targets/armvirt/32/openwrt-armvirt-32-root.ext4.gz bin/ || { echo "32ä½æ–‡ä»¶å¤åˆ¶å¤±è´¥"; exit 1; }

    - name: Generate release tag
      id: tag
      run: |
        release_tag=$(date +"%Y.%m.%d-%H%M")
        echo "::set-output name=release_tag::$release_tag"
        # ç”Ÿæˆæ›´è¯¦ç»†çš„å‘å¸ƒè¯´æ˜Ž
        cat > release.txt << EOF
        è‡ªåŠ¨æž„å»ºäºŽ: $(date +"%Y-%m-%d %H:%M:%S")
        åŸºäºŽç‰ˆæœ¬: openwrt19.07.10
        
        åŒ…å«æ–‡ä»¶:
        ðŸ”— recoverybox32.ext4 (32ä½ç‰ˆæœ¬)
        ðŸ”— recoverybox64.ext4 (64ä½ç‰ˆæœ¬)
        ðŸ”— openwrt-armvirt-32-root.ext4.gz
        ðŸ”— openwrt-armvirt-64-root.ext4.gz
        EOF
        echo "::set-output name=status::success"

    - name: Upload firmware to release
      uses: softprops/action-gh-release@v2  # ä½¿ç”¨å›ºå®šç‰ˆæœ¬
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: |
          bin/*.ext4
          bin/*.gz
        draft: false
        prerelease: false

    - name: Delete old workflow runs
      uses: GitRML/delete-workflow-runs@v1  # ä½¿ç”¨å›ºå®šç‰ˆæœ¬
      with:
        retain_days: 1
        keep_minimum_runs: 3
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Remove old releases
      uses: dev-drprasad/delete-older-releases@v0.2.0  # æ›´æ–°åˆ°è¾ƒæ–°ç¨³å®šç‰ˆæœ¬
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

